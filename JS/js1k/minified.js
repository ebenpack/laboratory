W=a.width;H=a.height;X=a.addEventListener;V=a.removeEventListener;w=200;h=80;l=[];q=[];o=1/0.56;nb=v=!0;fp=[];dm=0;a.style.background="#000";f=10;MF=Math.floor;MA=Math.abs;MS=Math.sqrt;Mp=Math.pow;P=Math.PI;Mm="mousemove";Mu="mouseup";R="red";G="#0F0";Y="#FF0";p=MF(W/w);T=255;bp=c.beginPath.bind(c);st=c.stroke.bind(c);cp=c.closePath.bind(c);cf=c.fill.bind(c);ca=c.arc.bind(c);function L(e){return e.length}
function I(){for(x=fp.length=0;20>x;x++)for(y=0;8>y;y++)l[x*f][y*f].b||fp.push({x:x*f,y:y*f})}function DS(e,d,g,k){id=k.data;for(var m=d*p;m<(d+1)*p;m++)for(var n=e*p;n<(e+1)*p;n++){var r=4*(n+m*k.width);id[r+0]=g.r;id[r+1]=g.g;id[r+2]=g.b;id[r+3]=g.a}}function DF(e,d,g,k){c.strokeStyle=R;c.fillStyle=R;var m=w;e*=p;d*=p;bp();c.moveTo(e,d);c.lineTo(Math.round(e+g*p*m),d+k*p*m);st();bp();ca(e,d,1,0,2*P,!1);st();cp()}function DP(e,d){c.fillStyle=G;bp();ca(e*p,d*p,1,0,2*P,!1);cf();cp()}
function DB(){c.fillStyle=Y;for(x=0;x<w;x++)for(y=0;y<h;y++)l[x][y].b&&(bp(),c.rect(x*p,y*p,p,p),cf(),cp())}function GC(e,d,g){var k=(d+g)/2,m=MA(g-k),n={r:0,g:0,b:0,a:0};e>g&&(e=g);e<d&&(e=d);e>=k?n.r=T:n.g=T;n.a=MF(MA(e)*(1/m)*T);return n}
function D(){a.width=W;var e=c.createImageData(W,H);for(x=0;x<w;x++)for(y=0;y<h;y++)if(!l[x][y].b){var d={r:0,g:0,b:0,a:0},g=l[x][y].x,k=l[x][y].y;if(0===dm)d=MS(Mp(g,2)+Mp(k,2)),d={r:0,a:MF(4E3*d),b:0,g:T},d.g>T&&(d.g=T),0>d.g&&(d.g=0);else if(1==dm)d=GC(g,-0.04,0.04);else if(2==dm)d=GC(k,-0.04,0.04);else if(3==dm)d={r:0,a:MF(20*(T-T/MA(l[x][y].n))),b:0,g:T},d.g>T&&(d.g=T),0>d.g&&(d.g=0);else if(4==dm)d=GC(l[x][y].c,-0.1,0.1);else if(5==dm)continue;DS(x,y,d,e)}c.putImageData(e,0,0);x=0;for(ln=L(fp);x<
ln;x++)DP(fp[x].x,fp[x].y);if(v)for(x=0;x<w;x+=f)for(y=0;y<h;y+=f)g=l[x][y].x,k=l[x][y].y,DF(x,y,g,k);nb&&(DB(),nb=!1)}function C(){a.width=W;DB();nb=!1}
function M(e){if(1===e.which){var d=e.layerX,g=e.layerY,k=function(e){var k=e.layerX;e=e.layerY;var m=(k-d)/p/f,s=(e-g)/p/f;0.1<MA(m)&&(m=0.1*MA(m)/m);0.1<MA(s)&&(s=0.1*MA(s)/s);var B=MF(k/p),z=MF(e/p);for(x=-5;5>=x;x++)for(y=-5;5>=y;y++)0<=B+x&&B+x<w&&0<=z+y&&z+y<h&&!l[B+x][z+y].b&&5>MS(x*x+y*y)&&q.push([B+x,z+y,m,s]);d=k;g=e},m=function(d){V(Mm,k,!1);V(Mu,m,!1)};X(Mm,k,!1);X(Mu,m,!1)}}
function PB(e){e.preventDefault();var d=e.layerX,g=e.layerY,k=MF(d/p),m=MF(g/p),n=!0;l[k][m].b&&(n=!1);l[k][m].b=n;var r=function(e){d=e.layerX;g=e.layerY;k=MF(d/p);m=MF(g/p);l[k][m].b=n;nb=!0},A=function(d){V(Mm,r,!1);V(Mu,A,!1)};X(Mm,r,!1);X(Mu,A,!1)}function K(e){e=e.keyCode;72==e&&(dm=(dm+1)%6);74==e&&(v=!v);75==e&&(0<L(fp)?fp.length=0:I());76==e&&t()}X("mousedown",M,!1);X("contextmenu",PB,!1);b.addEventListener("keydown",K,!1);f9=4/9;o9=1/9;o3=1/36;
ND={0:{x:0,y:0},1:{x:1,y:0},2:{x:0,y:-1},3:{x:-1,y:0},4:{x:0,y:1},5:{x:1,y:-1},6:{x:-1,y:-1},7:{x:-1,y:1},8:{x:1,y:1}};Rf={0:0,1:3,2:4,3:1,4:2,5:7,6:8,7:5,8:6};function LN(){this.d=[0,0,0,0,0,0,0,0,0];this.s=[0,0,0,0,0,0,0,0,0];this.y=this.x=this.n=0;this.b=!1;this.c=0}function ml(e,d){for(var g=0;g<e;g++){l[g]=[];for(var k=0;k<d;k++)l[g][k]=new LN}}function IF(e,d,g){for(x=0;x<w;x++)for(y=0;y<h;y++){var k=l[x][y];if(!k.b){k.n=g;k.x=e;k.y=d;var m=E(e,d,g);k.d=m.slice(0);k.s=m.slice(0)}}}
function MP(){x=0;for(ln=L(fp);x<ln;x++){var e=fp[x],d=MF(e.x),g=MF(e.y);0<=d&&d<w&&0<=g&&g<h&&(d=l[d][g],g=d.y,e.x+=d.x,e.y+=g)}}function IB(e){for(x=0;x<w;x++)for(y=0;y<h;y++)l[x][y].b=!1;nb=!0}function E(e,d,g){var k=[],m=3*e,n=3*d,r=e*e,A=d*d,s=2*e*d,B=r+A;e=1.5*B;d=o9*g;var z=o3*g,r=4.5*r-e,A=4.5*A-e,F=1+m,m=1-m,J=4.5*(B+s)-e,s=4.5*(B-s)-e;k[0]=f9*g*(1-e);k[1]=d*(F+r);k[2]=d*(1-n+A);k[3]=d*(m+r);k[4]=d*(1+n+A);k[5]=z*(F-n+s);k[6]=z*(m-n+J);k[7]=z*(m+n+s);k[8]=z*(F+n+J);return k}
function S(){for(x=0;x<w;x++)for(y=0;y<h;y++){var e=l[x][y];if(!e.b){0<x&&x<w-1&&0<y&&y<h-1&&(e.c=l[x+1][y].y-l[x-1][y].y-l[x][y+1].x+l[x][y-1].x);for(var d=0;9>d;d++){var g=ND[d],k=g.x+x,g=g.y+y;0<=k&&k<w&&0<=g&&g<h&&(l[k][g].b?l[x][y].s[Rf[d]]=e.d[d]:l[k][g].s[d]=e.d[d])}}}}
function Z(){for(x=0;x<w;x++)for(y=0;y<h;y++){var e=l[x][y];if(!e.b){for(var d=e.d,g=0;9>g;g++)d[g]=e.s[g];var k=d[1]+d[5]+d[8],m=d[4]+d[7]+d[8],g=d[0]+d[2]+d[3]+d[6]+k+m-d[8],k=(k-d[3]-d[6]-d[7])/g,m=(m-d[2]-d[5]-d[6])/g;e.n=g;e.x=k;e.y=m;g=E(k,m,g);for(m=0;9>m;m++)k=d[m],e.d[m]=k+o*(g[m]-k)}}}function U(){for(var e=0;e<f;e++)for(S(),Z(),0<L(fp)&&MP();0<L(q);){u=q.shift();var d=l[u[0]][u[1]];d.d=E(u[2],u[3],d.n)}D();requestAnimationFrame(U)}
function t(){ml(w,h);IB();IF(0,0,1);q.length=0;I();D();U()}t();