var config={lattice_width:200,lattice_height:80},boltzmann=boltzmann||{},boltzmann=function(a){var p=document.getElementById("boltzmann"),k=a.lattice_width;return{lattice_width:k,lattice_height:a.lattice_height,lattice:[],queue:[],viscosity:.02,omega:1/.56,draw_mode:0,flow_vectors:!1,new_barrier:!0,flow_particles:[],flow_speed:0,animation_id:null,boltzcanvas:p,vectorcanvas:document.getElementById("vectorcanvas"),particlecanvas:document.getElementById("particlecanvas"),barriercanvas:document.getElementById("barriercanvas"),
boltzctx:null,vectorctx:null,particlectx:null,barrierctx:null,steps_per_frame:10,px_per_node:Math.floor(p.width/k)}}(config);
(function(){for(var a=0,p=["webkit","moz"],k=0;k<p.length&&!window.requestAnimationFrame;++k)window.requestAnimationFrame=window[p[k]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[p[k]+"CancelAnimationFrame"]||window[p[k]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(k,p){var r=(new Date).getTime(),h=Math.max(0,16-(r-a)),q=window.setTimeout(function(){k(r+h)},h);a=r+h;return q});window.cancelAnimationFrame||(window.cancelAnimationFrame=
function(a){clearTimeout(a)})})();boltzmann=boltzmann||{};
boltzmann=(boltzmann=function(a){a.drawing=function(){function p(a,c,b){if(0==c)b=c=a=b;else{var f=function(a,c,b){0>b&&(b+=1);1<b&&(b-=1);return b<1/6?a+6*(c-a)*b:.5>b?c:b<2/3?a+(c-a)*(2/3-b)*6:a},e=.5>b?b*(1+c):b+c-b*c,g=2*b-e;b=f(g,e,a+1/3);c=f(g,e,a);a=f(g,e,a-1/3)}return{r:Math.round(255*b),g:Math.round(255*c),b:Math.round(255*a),a:255}}function k(a){for(var b=0;b<a;b++){var c=b,f;f=0-a/(b-a);f=p(1-f,1,f/2);J[c]=f}}function A(){for(var a=0;a<c;a++)for(var b=0;b<g;b++)l[a][b].barrier&&(v.beginPath(),
v.rect(a*u,b*u,u,u),v.fill(),v.closePath())}var y={},r=a.boltzcanvas,h=a.vectorcanvas,q=a.particlecanvas,d=a.barriercanvas,z,x,w,v,u=a.px_per_node,l=a.lattice,B=a.flow_particles,c=a.lattice_width,g=a.lattice_height,e=r.width,f=r.height,n,t,b,J=[];r.getContext?(a.boltzctx=r.getContext("2d"),a.vectorctx=h.getContext("2d"),a.particlectx=q.getContext("2d"),a.barrierctx=d.getContext("2d"),z=a.boltzctx,x=a.vectorctx,w=a.particlectx,v=a.barrierctx,x.strokeStyle="red",x.fillStyle="red",w.strokeStyle="black",
w.fillStyle="black",v.fillStyle="yellow",n=z.createImageData(e,f),t=n.data,b=n.width,k(400)):console.log("This browser does not support canvas");y.draw=function(){var d=a.draw_mode;a.flow_vectors&&x.clearRect(0,0,e,f);if(0<B.length){w.clearRect(0,0,e,f);for(var m=0,h=B.length;m<h;m++){var s=B[m].x,q=B[m].y;w.beginPath();w.arc(s*u,q*u,1,0,2*Math.PI,!1);w.fill();w.closePath()}}a.new_barrier&&(v.clearRect(0,0,e,f),A(v),a.new_barrier=!1);for(m=0;m<c;m++)for(h=0;h<g;h++)if(!l[m][h].barrier){var s={r:0,
g:0,b:0,a:0},s=0,q=l[m][h].ux,k=l[m][h].uy;if(a.flow_vectors&&0===m%10&&0===h%10){var r=q,p=k,y=m*u,I=h*u;x.beginPath();x.moveTo(y,I);x.lineTo(Math.round(y+r*u*200),I+p*u*200);x.stroke();x.beginPath();x.arc(y,I,1,0,2*Math.PI,!1);x.fill();x.closePath()}if(0===d)s=Math.sqrt(Math.pow(q,2)+Math.pow(k,2)),s=parseInt(400*(s+.21));else if(1==d)s=parseInt(400*(q+.21052631578));else if(2==d)s=parseInt(400*(k+.21052631578));else if(3==d)s=parseInt(400*(l[m][h].density-.75));else if(4==d)s=parseInt(400*(l[m][h].curl+
.25196850393));else if(5==d)continue;400<=s?s=399:0>s&&(s=0);s=J[s];for(q=h*u;q<(h+1)*u;q++)for(k=m*u;k<(m+1)*u;k++)r=4*(k+q*b),t[r+0]=s.r,t[r+1]=s.g,t[r+2]=s.b,t[r+3]=s.a}z.putImageData(n,0,0)};y.clear=function(){n=z.createImageData(e,f);t=n.data;b=n.width;x.clearRect(0,0,e,f);w.clearRect(0,0,e,f);z.clearRect(0,0,e,f);v.clearRect(0,0,e,f);A();a.new_barrier=!1};return y}();return a}(boltzmann))||{};
boltzmann=(boltzmann=function(a){a.events=function(){function p(l){if(1===(l.which||l.button)&&a.animation_id){var B=l.hasOwnProperty("offsetX")?l.offsetX:l.layerX,c=l.hasOwnProperty("offsetY")?l.offsetY:l.layerY,g=function(a){var e=a.hasOwnProperty("offsetX")?a.offsetX:a.layerX;a=a.hasOwnProperty("offsetY")?a.offsetY:a.layerY;var g=(e-B)/h/z,b=(a-c)/h/z;.1<Math.abs(g)&&(g=.1*Math.abs(g)/g);.1<Math.abs(b)&&(b=.1*Math.abs(b)/b);for(var d=Math.floor(e/h),l=Math.floor(a/h),m=-5;5>=m;m++)for(var k=-5;5>=
k;k++)0<=d+m&&d+m<A&&0<=l+k&&l+k<y&&!r[d+m][l+k].barrier&&5>Math.sqrt(m*m+k*k)&&q.push([d+m,l+k,g,b]);B=e;c=a},e=function(a){d.removeEventListener("mousemove",g,!1);d.removeEventListener("mouseup",e,!1);d.removeEventListener("touchmove",g,!1);document.body.removeEventListener("touchend",e,!1)};d.addEventListener("mousemove",g,!1);d.addEventListener("mouseup",e,!1);d.addEventListener("touchmove",g,!1);document.body.addEventListener("touchend",e,!1)}}function k(d){window.cancelAnimationFrame(a.animation_id);
a.animation_id=null;d.innerHTML="Start"}var A=a.lattice_width,y=a.lattice_height,r=a.lattice,h=a.px_per_node,q=a.queue,d=a.boltzcanvas,z=a.steps_per_frame,x=a.flow_particles,w,v,u;d.addEventListener("mousedown",p,!1);d.addEventListener("touchstart",p,!1);d.addEventListener("contextmenu",function(l){l.preventDefault();var B=l.hasOwnProperty("offsetX")?l.offsetX:l.layerX,c=l.hasOwnProperty("offsetY")?l.offsetY:l.layerY,g=Math.floor(B/h),e=Math.floor(c/h),f=!0;r[g][e].barrier&&(f=!1);r[g][e].barrier=
f;var n=function(b){B=b.hasOwnProperty("offsetX")?b.offsetX:b.layerX;c=b.hasOwnProperty("offsetY")?b.offsetY:b.layerY;g=Math.floor(B/h);e=Math.floor(c/h);r[g][e].barrier=f;a.new_barrier=!0;a.animation_id||a.drawing.draw()},k=function(a){d.removeEventListener("mousemove",n,!1);d.removeEventListener("mouseup",k,!1);d.removeEventListener("touchmove",n,!1);document.body.removeEventListener("touchend",k,!1)};d.addEventListener("mousemove",n,!1);d.addEventListener("mouseup",k,!1);d.addEventListener("touchmove",
n,!1);document.body.addEventListener("touchend",k,!1)},!1);document.getElementById("drawmode").addEventListener("change",function(d){a.draw_mode=this.selectedIndex;5==a.draw_mode&&a.drawing.clear()},!1);document.getElementById("viscosity").addEventListener("input",function(d){a.viscosity=parseInt(this.value,10)/100;a.omega=1/(3*a.viscosity+.5)},!1);document.getElementById("speed").addEventListener("input",function(d){a.steps_per_frame=parseInt(this.value,10)},!1);v=document.getElementById("flowvectors");
v.addEventListener("click",function(h){this.checked?a.flow_vectors=!0:(a.flow_vectors=!1,a.vectorctx.clearRect(0,0,d.width,d.height))},!1);u=document.getElementById("flowparticles");u.addEventListener("click",function(h){this.checked?a.main.init_flow_particles():(x.length=0,a.particlectx.clearRect(0,0,d.width,d.height))},!1);w=document.getElementById("play");w.addEventListener("click",function(d){a.animation_id?k(this):(a.queue.length=0,a.main.updater(),this.innerHTML="Pause")},!1);document.getElementById("reset").addEventListener("click",
function(d){k(w);a.flow_vectors=!1;a.flow_particles.length=0;v.checked=!1;u.checked=!1;a.main.init();a.drawing.clear()},!1);document.getElementById("clearbarriers").addEventListener("click",function(d){a.main.init_barrier([]);a.drawing.clear()},!1);document.getElementById("flow-speed").addEventListener("input",function(d){a.flow_speed=parseInt(this.value,10)/833},!1)}();return a}(boltzmann))||{};
boltzmann=function(a){a.main=function(){function p(){this.distribution=new Float64Array(9);this.stream=new Float64Array(9);this.uy=this.ux=this.density=0;this.barrier=!1;this.curl=0}function k(a){if(void 0!==a){for(var c=0;c<h;c++)for(var g=0;g<q;g++)d[c][g].barrier=!1;for(c=0;c<a.length;c++)d[a[c].x][a[c].y].barrier=!0}else for(c=0;c<h;c++)for(g=0;g<q;g++)if(0===c||c===h-1||0===g||g===q-1||10>Math.abs(h/2-c)&&10>Math.abs(q/2-g))d[c][g].barrier=!0}function A(a,c,d){var e=[],f=3*a,h=3*-c,k=a*a,b=-c*
-c;a=2*a*-c;c=k+b;var l=1.5*c;e[0]=x*d*(1-l);e[1]=w*d*(1+f+4.5*k-l);e[2]=w*d*(1+h+4.5*b-l);e[3]=w*d*(1-f+4.5*k-l);e[4]=w*d*(1-h+4.5*b-l);e[5]=v*d*(1+f+h+4.5*(c+a)-l);e[6]=v*d*(1-f+h+4.5*(c-a)-l);e[7]=v*d*(1-f-h+4.5*(c+a)-l);e[8]=v*d*(1+f-h+4.5*(c-a)-l);return e}var y={},r=a.queue,h=a.lattice_width,q=a.lattice_height,d=a.lattice,z=a.flow_particles,x=4/9,w=1/9,v=1/36,u={0:{x:0,y:0},1:{x:1,y:0},2:{x:0,y:-1},3:{x:-1,y:0},4:{x:0,y:1},5:{x:1,y:-1},6:{x:-1,y:-1},7:{x:-1,y:1},8:{x:1,y:1}},l={0:0,1:3,2:4,
3:1,4:2,5:7,6:8,7:5,8:6};y.updater=function(){var k=a.steps_per_frame,c,g=a.flow_speed;for(c=0;c<h-1;c++)d[c][0].distribution=A(g,0,1),d[c][q-1].distribution=A(g,0,1);for(c=0;c<q-1;c++)d[0][c].distribution=A(g,0,1),d[h-1][c].distribution=A(g,0,1);for(g=0;g<k;g++){for(c=0;c<h;c++)for(var e=0;e<q;e++){var f=d[c][e];if(!f.barrier)for(var n=0;9>n;n++){var t=u[n],b=t.x+c,t=t.y+e;0<=b&&b<h&&0<=t&&t<q&&(b=d[b][t],t=f.distribution,b.barrier?f.stream[l[n]]=t[n]:b.stream[n]=t[n])}}c=a.omega;for(e=1;e<h-1;e++)for(f=
1;f<q-1;f++){var p=d[e][f];if(!p.barrier){var n=p.distribution,b=p.stream,t=b[0]+b[1]+b[2]+b[3]+b[4]+b[5]+b[6]+b[7]+b[8],C=(b[1]+b[5]+b[8]-b[3]-b[6]-b[7])/t,m=(b[4]+b[7]+b[8]-b[2]-b[5]-b[6])/t;p.density=t;p.ux=C;p.uy=m;4==a.draw_mode&&0<e&&e<h-1&&0<f&&f<q-1&&(p.curl=d[e+1][f].uy-d[e-1][f].uy-d[e][f+1].ux+d[e][f-1].ux);var p=3*C,E=3*m,s=C*C,H=m*m,C=2*C*m,m=s+H,D=1.5*m,F=w*t,G=v*t;n[0]=b[0]+c*(x*t*(1-D)-b[0]);n[1]=b[1]+c*(F*(1+p+4.5*s-D)-b[1]);n[2]=b[2]+c*(F*(1-E+4.5*H-D)-b[2]);n[3]=b[3]+c*(F*(1-p+
4.5*s-D)-b[3]);n[4]=b[4]+c*(F*(1+E+4.5*H-D)-b[4]);n[5]=b[5]+c*(G*(1+p-E+4.5*(m-C)-D)-b[5]);n[6]=b[6]+c*(G*(1-p-E+4.5*(m+C)-D)-b[6]);n[7]=b[7]+c*(G*(1-p+E+4.5*(m-C)-D)-b[7]);n[8]=b[8]+c*(G*(1+p+E+4.5*(m+C)-D)-b[8])}}if(0<z.length)for(c=0,e=z.length;c<e;c++)f=z[c],n=Math.floor(f.x),b=Math.floor(f.y),0<=n&&n<h&&0<=b&&b<q&&(n=d[n][b],b=n.uy,f.x+=n.ux,f.y+=b),0<a.flow_speed&&f.x>h-2&&(f.x=1);for(;0<r.length;)c=r.shift(),e=d[c[0]][c[1]],e.distribution=A(c[2],c[3],e.density)}a.drawing.draw();a.animation_id=
requestAnimationFrame(y.updater)};y.init=function(){for(var l=h,c=q,g=d.length=0;g<l;g++){d[g]=[];for(var e=0;e<c;e++)d[g][e]=new p}k([]);for(l=0;l<h;l++)for(c=0;c<q;c++)if(g=d[l][c],!g.barrier){g.density=1;g.ux=0;g.uy=0;for(var e=A(0,0,1),f=0;9>f;f++)g.distribution[f]=e[f],g.stream[f]=e[f]}r.length=0;a.drawing.draw()};y.init_barrier=k;y.init_flow_particles=function(){z.length=0;for(var a=1;20>a;a++)for(var c=1;8>c;c++)d[10*a][10*c].barrier||z.push({x:10*a,y:10*c})};return y}();return a}(boltzmann);
boltzmann.main.init();
