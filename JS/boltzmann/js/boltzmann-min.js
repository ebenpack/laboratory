var config={lattice_width:200,lattice_height:80},boltzmann=boltzmann||{},boltzmann=function(a){var n=document.getElementById("boltzmann"),h=a.lattice_width;return{lattice_width:h,lattice_height:a.lattice_height,lattice:[],queue:[],viscosity:0.02,omega:1/0.56,draw_mode:0,flow_vectors:!1,new_barrier:!0,flow_particles:[],flow_speed:0,animation_id:null,boltzcanvas:n,vectorcanvas:document.getElementById("vectorcanvas"),particlecanvas:document.getElementById("particlecanvas"),barriercanvas:document.getElementById("barriercanvas"),
boltzctx:null,vectorctx:null,particlectx:null,barrierctx:null,steps_per_frame:10,px_per_node:Math.floor(n.width/h)}}(config);
(function(){for(var a=0,n=["webkit","moz"],h=0;h<n.length&&!window.requestAnimationFrame;++h)window.requestAnimationFrame=window[n[h]+"RequestAnimationFrame"],window.cancelAnimationFrame=window[n[h]+"CancelAnimationFrame"]||window[n[h]+"CancelRequestAnimationFrame"];window.requestAnimationFrame||(window.requestAnimationFrame=function(h,n){var s=(new Date).getTime(),f=Math.max(0,16-(s-a)),l=window.setTimeout(function(){h(s+f)},f);a=s+f;return l});window.cancelAnimationFrame||(window.cancelAnimationFrame=
function(a){clearTimeout(a)})})();boltzmann=boltzmann||{};
boltzmann=function(a){a.drawing=function(){function n(b,a,c){if(0==a)c=a=b=c;else{var e=function(a,b,c){0>c&&(c+=1);1<c&&(c-=1);return c<1/6?a+6*(b-a)*c:0.5>c?b:c<2/3?a+(b-a)*(2/3-c)*6:a},g=0.5>c?c*(1+a):c+a-c*a,k=2*c-g;c=e(k,g,b+1/3);a=e(k,g,b);b=e(k,g,b-1/3)}return{r:Math.round(255*c),g:Math.round(255*a),b:Math.round(255*b),a:255}}function h(a){for(var c=0;c<a;c++){var b=G,e=c,g;g=0-a/(c-a);g=n(1-g,1,g/2);b[e]=g}}function A(){for(var a=0;a<c;a++)for(var b=0;b<k;b++)m[a][b].barrier&&(t.beginPath(),
t.rect(a*u,b*u,u,u),t.fill(),t.closePath())}var x={},s=a.boltzcanvas,f=a.vectorcanvas,l=a.particlecanvas,d=a.barriercanvas,z,y,w,t,u=a.px_per_node,m=a.lattice,C=a.flow_particles,c=a.lattice_width,k=a.lattice_height,e=s.width,g=s.height,b,p,r,G=[];s.getContext?(a.boltzctx=s.getContext("2d"),a.vectorctx=f.getContext("2d"),a.particlectx=l.getContext("2d"),a.barrierctx=d.getContext("2d"),z=a.boltzctx,y=a.vectorctx,w=a.particlectx,t=a.barrierctx,y.strokeStyle="red",y.fillStyle="red",w.strokeStyle="black",
w.fillStyle="black",t.fillStyle="yellow",b=z.createImageData(e,g),p=b.data,r=b.width,h(400)):console.log("This browser does not support canvas");x.draw=function(){var d=a.draw_mode;a.flow_vectors&&y.clearRect(0,0,e,g);if(0<C.length){w.clearRect(0,0,e,g);for(var q=0,f=C.length;q<f;q++){var l=C[q].x,v=C[q].y,h=w;h.beginPath();h.arc(l*u,v*u,1,0,2*Math.PI,!1);h.fill();h.closePath()}}a.new_barrier&&(t.clearRect(0,0,e,g),A(t),a.new_barrier=!1);for(q=0;q<c;q++)for(f=0;f<k;f++)if(!m[q][f].barrier){l={r:0,
g:0,b:0,a:0};l=m[q][f].ux;v=m[q][f].uy;if(a.flow_vectors&&0===q%10&&0===f%10){var h=l,s=v,n=y,x=q*u,F=f*u;n.beginPath();n.moveTo(x,F);n.lineTo(Math.round(x+h*u*200),F+s*u*200);n.stroke();n.beginPath();n.arc(x,F,1,0,2*Math.PI,!1);n.fill();n.closePath()}if(0===d)l=Math.sqrt(Math.pow(l,2)+Math.pow(v,2)),color_index=parseInt(400*(l+0.21));else if(1==d)color_index=parseInt(400*(l+0.21052631578));else if(2==d)color_index=parseInt(400*(v+0.21052631578));else if(3==d)color_index=parseInt(400*(m[q][f].density-
0.75));else if(4==d)color_index=parseInt(400*(m[q][f].curl+0.25196850393));else if(5==d)continue;400<=color_index?color_index=399:0>color_index&&(color_index=0);l=G[color_index];for(v=f*u;v<(f+1)*u;v++)for(h=q*u;h<(q+1)*u;h++)s=4*(h+v*r),p[s+0]=l.r,p[s+1]=l.g,p[s+2]=l.b,p[s+3]=l.a}z.putImageData(b,0,0)};x.clear=function(){b=z.createImageData(e,g);p=b.data;r=b.width;y.clearRect(0,0,e,g);w.clearRect(0,0,e,g);z.clearRect(0,0,e,g);t.clearRect(0,0,e,g);A();a.new_barrier=!1};return x}();return a}(boltzmann);boltzmann=boltzmann||{};
boltzmann=function(a){a.events=function(){function n(m){if(1===(m.which||m.button)&&a.animation_id){var C=m.hasOwnProperty("offsetX")?m.offsetX:m.layerX,c=m.hasOwnProperty("offsetY")?m.offsetY:m.layerY,k=function(a){var b=a.hasOwnProperty("offsetX")?a.offsetX:a.layerX;a=a.hasOwnProperty("offsetY")?a.offsetY:a.layerY;var e=(b-C)/f/z,k=(a-c)/f/z;0.1<Math.abs(e)&&(e=0.1*Math.abs(e)/e);0.1<Math.abs(k)&&(k=0.1*Math.abs(k)/k);for(var d=Math.floor(b/f),m=Math.floor(a/f),q=-5;5>=q;q++)for(var h=-5;5>=h;h++)0<=
d+q&&d+q<A&&0<=m+h&&m+h<x&&!s[d+q][m+h].barrier&&5>Math.sqrt(q*q+h*h)&&l.push([d+q,m+h,e,k]);C=b;c=a},e=function(a){d.removeEventListener("mousemove",k,!1);d.removeEventListener("mouseup",e,!1);d.removeEventListener("touchmove",k,!1);document.body.removeEventListener("touchend",e,!1)};d.addEventListener("mousemove",k,!1);d.addEventListener("mouseup",e,!1);d.addEventListener("touchmove",k,!1);document.body.addEventListener("touchend",e,!1)}}function h(d){window.cancelAnimationFrame(a.animation_id);
a.animation_id=null;d.innerHTML="Start"}var A=a.lattice_width,x=a.lattice_height,s=a.lattice,f=a.px_per_node,l=a.queue,d=a.boltzcanvas,z=a.steps_per_frame,y=a.flow_particles,w,t,u;d.addEventListener("mousedown",n,!1);d.addEventListener("touchstart",n,!1);d.addEventListener("contextmenu",function(m){m.preventDefault();var h=m.hasOwnProperty("offsetX")?m.offsetX:m.layerX,c=m.hasOwnProperty("offsetY")?m.offsetY:m.layerY,k=Math.floor(h/f),e=Math.floor(c/f),g=!0;s[k][e].barrier&&(g=!1);s[k][e].barrier=
g;var b=function(b){h=b.hasOwnProperty("offsetX")?b.offsetX:b.layerX;c=b.hasOwnProperty("offsetY")?b.offsetY:b.layerY;k=Math.floor(h/f);e=Math.floor(c/f);s[k][e].barrier=g;a.new_barrier=!0;a.animation_id||a.drawing.draw()},p=function(a){d.removeEventListener("mousemove",b,!1);d.removeEventListener("mouseup",p,!1);d.removeEventListener("touchmove",b,!1);document.body.removeEventListener("touchend",p,!1)};d.addEventListener("mousemove",b,!1);d.addEventListener("mouseup",p,!1);d.addEventListener("touchmove",
b,!1);document.body.addEventListener("touchend",p,!1)},!1);document.getElementById("drawmode").addEventListener("change",function(d){a.draw_mode=this.selectedIndex;5==a.draw_mode&&a.drawing.clear()},!1);document.getElementById("viscosity").addEventListener("input",function(d){a.viscosity=parseInt(this.value,10)/100;a.omega=1/(3*a.viscosity+0.5)},!1);document.getElementById("speed").addEventListener("input",function(d){a.steps_per_frame=parseInt(this.value,10)},!1);t=document.getElementById("flowvectors");
t.addEventListener("click",function(f){this.checked?a.flow_vectors=!0:(a.flow_vectors=!1,a.vectorctx.clearRect(0,0,d.width,d.height))},!1);u=document.getElementById("flowparticles");u.addEventListener("click",function(f){if(this.checked)for(f=y.length=0;20>f;f++)for(var h=0;8>h;h++)s[10*f][10*h].barrier||y.push({x:10*f,y:10*h});else y.length=0,a.particlectx.clearRect(0,0,d.width,d.height)},!1);w=document.getElementById("play");w.addEventListener("click",function(d){a.animation_id?h(this):(a.queue.length=
0,a.main.updater(),this.innerHTML="Pause")},!1);document.getElementById("reset").addEventListener("click",function(d){h(w);a.flow_vectors=!1;a.flow_particles.length=0;t.checked=!1;u.checked=!1;a.main.init();a.drawing.clear()},!1);document.getElementById("clearbarriers").addEventListener("click",function(d){a.main.init_barrier([]);a.drawing.clear()},!1);document.getElementById("flow-speed").addEventListener("input",function(d){a.flow_speed=parseInt(this.value,10)/833},!1)}();return a}(boltzmann);boltzmann=boltzmann||{};
boltzmann=function(a){a.main=function(){function n(){this.distribution=[0,0,0,0,0,0,0,0,0];this.stream=[0,0,0,0,0,0,0,0,0];this.uy=this.ux=this.density=0;this.barrier=!1;this.curl=0}function h(a){if(void 0!==a){for(var c=0;c<f;c++)for(var k=0;k<l;k++)d[c][k].barrier=!1;for(c=0;c<a.length;c++)d[bar[c].x][bar[c].y].barrier=!0}else for(c=0;c<f;c++)for(k=0;k<l;k++)if(0===c||c===f-1||0===k||k===l-1||10>Math.abs(f/2-c)&&10>Math.abs(l/2-k))d[c][k].barrier=!0}function A(a,c,d){var e=[],g=3*a,b=3*-c,f=a*a,
h=-c*-c;a=2*a*-c;c=f+h;var l=1.5*c;e[0]=y*d*(1-l);e[1]=w*d*(1+g+4.5*f-l);e[2]=w*d*(1+b+4.5*h-l);e[3]=w*d*(1-g+4.5*f-l);e[4]=w*d*(1-b+4.5*h-l);e[5]=t*d*(1+g+b+4.5*(c+a)-l);e[6]=t*d*(1-g+b+4.5*(c-a)-l);e[7]=t*d*(1-g-b+4.5*(c+a)-l);e[8]=t*d*(1+g-b+4.5*(c-a)-l);return e}var x={},s=a.queue,f=a.lattice_width,l=a.lattice_height,d=a.lattice,z=a.flow_particles,y=4/9,w=1/9,t=1/36,u={0:{x:0,y:0},1:{x:1,y:0},2:{x:0,y:-1},3:{x:-1,y:0},4:{x:0,y:1},5:{x:1,y:-1},6:{x:-1,y:-1},7:{x:-1,y:1},8:{x:1,y:1}},m={0:0,1:3,
2:4,3:1,4:2,5:7,6:8,7:5,8:6};x.updater=function(){var h=a.steps_per_frame,c,k=a.flow_speed;for(c=0;c<f-1;c++)d[c][0].distribution=A(k,0,1),d[c][l-1].distribution=A(k,0,1);for(c=0;c<l-1;c++)d[0][c].distribution=A(k,0,1),d[f-1][c].distribution=A(k,0,1);for(k=0;k<h;k++){for(c=0;c<f;c++)for(var e=0;e<l;e++){var g=d[c][e];if(!g.barrier)for(var b=0;9>b;b++){var p=u[b],r=p.x+c,p=p.y+e;0<=r&&r<f&&0<=p&&p<l&&(d[r][p].barrier?d[c][e].stream[m[b]]=g.distribution[b]:d[r][p].stream[b]=g.distribution[b])}}c=a.omega;
for(e=1;e<f-1;e++)for(g=1;g<l-1;g++)if(p=d[e][g],!p.barrier){b=p.distribution;for(r=0;9>r;r++)b[r]=p.stream[r];var r=b[0]+b[1]+b[2]+b[3]+b[4]+b[5]+b[6]+b[7]+b[8],n=(b[1]+b[5]+b[8]-b[3]-b[6]-b[7])/r,B=(b[4]+b[7]+b[8]-b[2]-b[5]-b[6])/r;p.density=r;p.ux=n;p.uy=B;4==a.draw_mode&&0<e&&e<f-1&&0<g&&g<l-1&&(p.curl=d[e+1][g].uy-d[e-1][g].uy-d[e][g+1].ux+d[e][g-1].ux);var p=3*n,q=3*B,D=n*n,E=B*B,n=2*n*B,B=D+E,v=1.5*B;b[0]+=c*(y*r*(1-v)-b[0]);b[1]+=c*(w*r*(1+p+4.5*D-v)-b[1]);b[2]+=c*(w*r*(1-q+4.5*E-v)-b[2]);
b[3]+=c*(w*r*(1-p+4.5*D-v)-b[3]);b[4]+=c*(w*r*(1+q+4.5*E-v)-b[4]);b[5]+=c*(t*r*(1+p-q+4.5*(B-n)-v)-b[5]);b[6]+=c*(t*r*(1-p-q+4.5*(B+n)-v)-b[6]);b[7]+=c*(t*r*(1-p+q+4.5*(B-n)-v)-b[7]);b[8]+=c*(t*r*(1+p+q+4.5*(B+n)-v)-b[8])}if(0<z.length)for(c=0,e=z.length;c<e;c++)g=z[c],b=Math.floor(g.x),r=Math.floor(g.y),0<=b&&b<f&&0<=r&&r<l&&(b=d[b][r],r=b.uy,g.x+=b.ux,g.y+=r),0<a.flow_speed&&g.x>f-2&&(g.x=1);for(;0<s.length;)c=s.shift(),e=d[c[0]][c[1]],e.distribution=A(c[2],c[3],e.density)}a.drawing.draw();a.animation_id=
requestAnimationFrame(x.updater)};x.init=function(){for(var m=f,c=l,k=d.length=0;k<m;k++){d[k]=[];for(var e=0;e<c;e++)d[k][e]=new n}h([]);for(m=0;m<f;m++)for(c=0;c<l;c++)k=d[m][c],k.barrier||(k.density=1,k.ux=0,k.uy=0,e=A(0,0,1),k.distribution=e.slice(0),k.stream=e.slice(0));s.length=0;a.drawing.draw()};x.init_barrier=h;return x}();return a}(boltzmann);boltzmann.main.init();
