var config={lattice_width:200,lattice_height:80};var boltzmann=boltzmann||{};
boltzmann=function(settings){var canvas=document.getElementById("boltzmann");var lattice_width=settings.lattice_width;var lattice_height=settings.lattice_height;var viscosity=0.02;var main={lattice_width:lattice_width,lattice_height:lattice_height,lattice:[],queue:[],viscosity:viscosity,omega:1/(3*viscosity+0.5),draw_mode:0,flow_vectors:false,new_barrier:true,flow_particles:[],flow_speed:0,animation_id:null,boltzcanvas:canvas,vectorcanvas:document.getElementById("vectorcanvas"),particlecanvas:document.getElementById("particlecanvas"),
barriercanvas:document.getElementById("barriercanvas"),boltzctx:null,vectorctx:null,particlectx:null,barrierctx:null,steps_per_frame:10,px_per_node:Math.floor(canvas.width/lattice_width)};return main}(config);
(function(){var lastTime=0;var vendors=["webkit","moz"];for(var x=0;x<vendors.length&&!window.requestAnimationFrame;++x){window.requestAnimationFrame=window[vendors[x]+"RequestAnimationFrame"];window.cancelAnimationFrame=window[vendors[x]+"CancelAnimationFrame"]||window[vendors[x]+"CancelRequestAnimationFrame"]}if(!window.requestAnimationFrame)window.requestAnimationFrame=function(callback,element){var currTime=(new Date).getTime();var timeToCall=Math.max(0,16-(currTime-lastTime));var id=window.setTimeout(function(){callback(currTime+
timeToCall)},timeToCall);lastTime=currTime+timeToCall;return id};if(!window.cancelAnimationFrame)window.cancelAnimationFrame=function(id){clearTimeout(id)}})();var boltzmann=boltzmann||{};
boltzmann=function(module){module.drawing=function(){var drawing={};var boltzcanvas=module.boltzcanvas;var vectorcanvas=module.vectorcanvas;var particlecanvas=module.particlecanvas;var barriercanvas=module.barriercanvas;var boltzctx;var vectorctx;var particlectx;var barrierctx;var px_per_node=module.px_per_node;var lattice=module.lattice;var particles=module.flow_particles;var lattice_width=module.lattice_width;var lattice_height=module.lattice_height;var canvas_width=boltzcanvas.width;var canvas_height=
boltzcanvas.height;var image;var image_data;var image_width;var color_array=[];var num_colors=400;(function(){if(boltzcanvas.getContext){module.boltzctx=boltzcanvas.getContext("2d");module.vectorctx=vectorcanvas.getContext("2d");module.particlectx=particlecanvas.getContext("2d");module.barrierctx=barriercanvas.getContext("2d");boltzctx=module.boltzctx;vectorctx=module.vectorctx;particlectx=module.particlectx;barrierctx=module.barrierctx;vectorctx.strokeStyle="red";vectorctx.fillStyle="red";particlectx.strokeStyle=
"black";particlectx.fillStyle="black";barrierctx.fillStyle="yellow";image=boltzctx.createImageData(canvas_width,canvas_height);image_data=image.data;image_width=image.width;compute_color_array(num_colors)}else console.log("This browser does not support canvas")})();function hslToRgb(h,s,l){var r,g,b;if(s==0)r=g=b=l;else{function hue2rgb(p,q,t){if(t<0)t+=1;if(t>1)t-=1;if(t<1/6)return p+(q-p)*6*t;if(t<1/2)return q;if(t<2/3)return p+(q-p)*(2/3-t)*6;return p}var q=l<0.5?l*(1+s):l+s-l*s;var p=2*l-q;r=
hue2rgb(p,q,h+1/3);g=hue2rgb(p,q,h);b=hue2rgb(p,q,h-1/3)}return{r:Math.round(r*255),g:Math.round(g*255),b:Math.round(b*255),a:255}}function get_color(min,max,val){var left_span=max-min;var right_span=1;var value_scaled=val-min/left_span;var h=1-value_scaled;var s=1;var l=value_scaled/2;return hslToRgb(h,s,l)}function compute_color_array(n){for(var i=0;i<n;i++)color_array[i]=get_color(n,i,0)}function draw_square(x,y,color,image){for(var ypx=y*px_per_node;ypx<(y+1)*px_per_node;ypx++)for(var xpx=x*px_per_node;xpx<
(x+1)*px_per_node;xpx++){var index=(xpx+ypx*image.width)*4;image.data[index+0]=color.r;image.data[index+1]=color.g;image.data[index+2]=color.b;image.data[index+3]=color.a}}function draw_flow_vector(x,y,ux,uy){var scale=200;var xpx=x*px_per_node;var ypx=y*px_per_node;vectorctx.beginPath();vectorctx.moveTo(xpx,ypx);vectorctx.lineTo(Math.round(xpx+ux*px_per_node*scale),ypx+uy*px_per_node*scale);vectorctx.stroke();vectorctx.beginPath();vectorctx.arc(xpx,ypx,1,0,2*Math.PI,false);vectorctx.fill();vectorctx.closePath()}
function draw_flow_particle(x,y){particlectx.beginPath();particlectx.arc(x*px_per_node,y*px_per_node,1,0,2*Math.PI,false);particlectx.fill();particlectx.closePath()}function draw_barriers(){for(var x=0;x<lattice_width;x++)for(var y=0;y<lattice_height;y++)if(lattice[x][y].barrier){barrierctx.beginPath();barrierctx.rect(x*px_per_node,y*px_per_node,px_per_node,px_per_node);barrierctx.fill();barrierctx.closePath()}}drawing.draw=function(){var draw_mode=module.draw_mode;if(module.flow_vectors)vectorctx.clearRect(0,
0,canvas_width,canvas_height);if(particles.length>0){particlectx.clearRect(0,0,canvas_width,canvas_height);for(var x=0,l=particles.length;x<l;x++)draw_flow_particle(particles[x].x,particles[x].y,particlectx)}if(module.new_barrier){barrierctx.clearRect(0,0,canvas_width,canvas_height);draw_barriers(barrierctx);module.new_barrier=false}for(var x=0;x<lattice_width;x++)for(var y=0;y<lattice_height;y++)if(!lattice[x][y].barrier){var color={"r":0,"g":0,"b":0,"a":0};var color_index=0;var ux=lattice[x][y].ux;
var uy=lattice[x][y].uy;if(module.flow_vectors&&(x%10===0&&y%10===0))draw_flow_vector(x,y,ux,uy);if(draw_mode===0){var speed=Math.sqrt(Math.pow(ux,2)+Math.pow(uy,2));color_index=parseInt((speed+0.21)*num_colors)}else if(draw_mode==1){var xvel=ux;color_index=parseInt((xvel+0.21052631578)*num_colors)}else if(draw_mode==2){var yvel=uy;color_index=parseInt((yvel+0.21052631578)*num_colors)}else if(draw_mode==3){var dens=lattice[x][y].density;color_index=parseInt((dens-0.75)*num_colors)}else if(draw_mode==
4){var curl=lattice[x][y].curl;color_index=parseInt((curl+0.25196850393)*num_colors)}else if(draw_mode==5)continue;if(color_index>=num_colors)color_index=num_colors-1;else if(color_index<0)color_index=0;var color=color_array[color_index];for(var ypx=y*px_per_node;ypx<(y+1)*px_per_node;ypx++)for(var xpx=x*px_per_node;xpx<(x+1)*px_per_node;xpx++){var index=(xpx+ypx*image_width)*4;image_data[index+0]=color.r;image_data[index+1]=color.g;image_data[index+2]=color.b;image_data[index+3]=color.a}}boltzctx.putImageData(image,
0,0)};drawing.clear=function(){image=boltzctx.createImageData(canvas_width,canvas_height);image_data=image.data;image_width=image.width;vectorctx.clearRect(0,0,canvas_width,canvas_height);particlectx.clearRect(0,0,canvas_width,canvas_height);boltzctx.clearRect(0,0,canvas_width,canvas_height);barrierctx.clearRect(0,0,canvas_width,canvas_height);draw_barriers();module.new_barrier=false};return drawing}();return module}(boltzmann);var boltzmann=boltzmann||{};
boltzmann=function(module){module.events=function(){var lattice_width=module.lattice_width;var lattice_height=module.lattice_height;var lattice=module.lattice;var px_per_node=module.px_per_node;var queue=module.queue;var canvas=module.boltzcanvas;var steps_per_frame=module.steps_per_frame;var particles=module.flow_particles;var startbutton;var flowvector;var flowparticle;function mousedownListener(e){var button=e.which||e.button;if(button!==1)return;if(!module.animation_id)return;var oldX=e.hasOwnProperty("offsetX")?
e.offsetX:e.layerX;var oldY=e.hasOwnProperty("offsetY")?e.offsetY:e.layerY;var moveListener=function(e){var radius=5;var newX=e.hasOwnProperty("offsetX")?e.offsetX:e.layerX;var newY=e.hasOwnProperty("offsetY")?e.offsetY:e.layerY;var dx=(newX-oldX)/px_per_node/steps_per_frame;var dy=(newY-oldY)/px_per_node/steps_per_frame;if(Math.abs(dx)>0.1)dx=0.1*Math.abs(dx)/dx;if(Math.abs(dy)>0.1)dy=0.1*Math.abs(dy)/dy;var lattice_x=Math.floor(newX/px_per_node);var lattice_y=Math.floor(newY/px_per_node);for(var x=
-radius;x<=radius;x++)for(var y=-radius;y<=radius;y++)if(lattice_x+x>=0&&(lattice_x+x<lattice_width&&(lattice_y+y>=0&&(lattice_y+y<lattice_height&&(!lattice[lattice_x+x][lattice_y+y].barrier&&Math.sqrt(x*x+y*y)<radius)))))queue.push([lattice_x+x,lattice_y+y,dx,dy]);oldX=newX;oldY=newY};var mouseupListener=function(e){canvas.removeEventListener("mousemove",moveListener,false);canvas.removeEventListener("mouseup",mouseupListener,false);canvas.removeEventListener("touchmove",moveListener,false);document.body.removeEventListener("touchend",
mouseupListener,false)};canvas.addEventListener("mousemove",moveListener,false);canvas.addEventListener("mouseup",mouseupListener,false);canvas.addEventListener("touchmove",moveListener,false);document.body.addEventListener("touchend",mouseupListener,false)}function place_barrier(e){e.preventDefault();var mouse_x=e.hasOwnProperty("offsetX")?e.offsetX:e.layerX;var mouse_y=e.hasOwnProperty("offsetY")?e.offsetY:e.layerY;var lattice_x=Math.floor(mouse_x/px_per_node);var lattice_y=Math.floor(mouse_y/px_per_node);
var draw=true;if(lattice[lattice_x][lattice_y].barrier)draw=false;lattice[lattice_x][lattice_y].barrier=draw;var moveListener=function(e){mouse_x=e.hasOwnProperty("offsetX")?e.offsetX:e.layerX;mouse_y=e.hasOwnProperty("offsetY")?e.offsetY:e.layerY;lattice_x=Math.floor(mouse_x/px_per_node);lattice_y=Math.floor(mouse_y/px_per_node);lattice[lattice_x][lattice_y].barrier=draw;module.new_barrier=true;if(!module.animation_id)module.drawing.draw()};var mouseupListener=function(e){canvas.removeEventListener("mousemove",
moveListener,false);canvas.removeEventListener("mouseup",mouseupListener,false);canvas.removeEventListener("touchmove",moveListener,false);document.body.removeEventListener("touchend",mouseupListener,false)};canvas.addEventListener("mousemove",moveListener,false);canvas.addEventListener("mouseup",mouseupListener,false);canvas.addEventListener("touchmove",moveListener,false);document.body.addEventListener("touchend",mouseupListener,false)}function update_draw_mode(e){module.draw_mode=this.selectedIndex;
if(module.draw_mode==5)module.drawing.clear()}function update_speed(e){module.steps_per_frame=parseInt(this.value,10)}function update_viscosity(e){module.viscosity=parseInt(this.value,10)/100;module.omega=1/(3*module.viscosity+0.5)}function toggle_vectors(e){if(this.checked)module.flow_vectors=true;else{module.flow_vectors=false;module.vectorctx.clearRect(0,0,canvas.width,canvas.height)}}function toggle_particles(e){if(this.checked)module.main.init_flow_particles();else{particles.length=0;module.particlectx.clearRect(0,
0,canvas.width,canvas.height)}}function stop(bttn){window.cancelAnimationFrame(module.animation_id);module.animation_id=null;bttn.innerHTML="Start"}function start(bttn){module.queue.length=0;module.main.updater();bttn.innerHTML="Pause"}function toggle_play_state(e){if(module.animation_id)stop(this);else start(this)}function reset(e){stop(startbutton);module.flow_vectors=false;module.flow_particles.length=0;flowvector.checked=false;flowparticle.checked=false;module.main.init();module.drawing.clear()}
function clear_barriers(e){module.main.init_barrier([]);module.drawing.clear()}function set_flow_speed(e){module.flow_speed=parseInt(this.value,10)/833}(function register(){canvas.addEventListener("mousedown",mousedownListener,false);canvas.addEventListener("touchstart",mousedownListener,false);canvas.addEventListener("contextmenu",place_barrier,false);var drawoptions=document.getElementById("drawmode");drawoptions.addEventListener("change",update_draw_mode,false);var viscoslider=document.getElementById("viscosity");
viscoslider.addEventListener("input",update_viscosity,false);var speedslider=document.getElementById("speed");speedslider.addEventListener("input",update_speed,false);flowvector=document.getElementById("flowvectors");flowvector.addEventListener("click",toggle_vectors,false);flowparticle=document.getElementById("flowparticles");flowparticle.addEventListener("click",toggle_particles,false);startbutton=document.getElementById("play");startbutton.addEventListener("click",toggle_play_state,false);var resetbutton=
document.getElementById("reset");resetbutton.addEventListener("click",reset,false);var clear=document.getElementById("clearbarriers");clear.addEventListener("click",clear_barriers,false);var flow_speed=document.getElementById("flow-speed");flow_speed.addEventListener("input",set_flow_speed,false)})()}();return module}(boltzmann);var boltzmann=boltzmann||{};
boltzmann=function(module){module.main=function(){var main={};var queue=module.queue;var lattice_width=module.lattice_width;var lattice_height=module.lattice_height;var lattice=module.lattice;var particles=module.flow_particles;var four9ths=4/9;var one9th=1/9;var one36th=1/36;var node_directions={0:{"x":0,"y":0},1:{"x":1,"y":0},2:{"x":0,"y":-1},3:{"x":-1,"y":0},4:{"x":0,"y":1},5:{"x":1,"y":-1},6:{"x":-1,"y":-1},7:{"x":-1,"y":1},8:{"x":1,"y":1}};var node_weight={0:four9ths,1:one9th,2:one9th,3:one9th,
4:one9th,5:one36th,6:one36th,7:one36th,8:one36th};var reflection={0:0,1:3,2:4,3:1,4:2,5:7,6:8,7:5,8:6};function LatticeNode(){this.distribution=[0,0,0,0,0,0,0,0,0];this.stream=[0,0,0,0,0,0,0,0,0];this.density=0;this.ux=0;this.uy=0;this.barrier=false;this.curl=0}function make_lattice(lattice_width,lattice_height){lattice.length=0;for(var i=0;i<lattice_width;i++){lattice[i]=[];for(var j=0;j<lattice_height;j++)lattice[i][j]=new LatticeNode}}function init_flow(ux,uy,rho){for(var x=0;x<lattice_width;x++)for(var y=
0;y<lattice_height;y++){var node=lattice[x][y];if(!node.barrier){node.density=rho;node.ux=ux;node.uy=uy;var eq=equilibrium(ux,uy,rho);node.distribution=eq.slice(0);node.stream=eq.slice(0)}}}function init_flow_particles(){particles.length=0;for(var x=1;x<20;x++)for(var y=1;y<8;y++)if(!lattice[x*10][y*10].barrier)particles.push({"x":x*10,"y":y*10})}function move_particles(){for(var x=0,l=particles.length;x<l;x++){var p=particles[x];var lx=Math.floor(p.x);var ly=Math.floor(p.y);if(lx>=0&&(lx<lattice_width&&
(ly>=0&&ly<lattice_height))){var node=lattice[lx][ly];var ux=node.ux;var uy=node.uy;p.x+=ux;p.y+=uy}if(module.flow_speed>0&&p.x>lattice_width-2)p.x=1}}function init_barrier(barrier){if(barrier!==undefined){for(var x=0;x<lattice_width;x++)for(var y=0;y<lattice_height;y++)lattice[x][y].barrier=false;for(var i=0;i<barrier.length;i++)lattice[barrier[i].x][barrier[i].y].barrier=true}else for(var x=0;x<lattice_width;x++)for(var y=0;y<lattice_height;y++)if(x===0||(x===lattice_width-1||(y===0||(y===lattice_height-
1||Math.abs(lattice_width/2-x)<10&&Math.abs(lattice_height/2-y)<10))))lattice[x][y].barrier=true}function equilibrium(ux,uy,rho){var eq=[];var ux3=3*ux;var uy3=3*-uy;var ux2=ux*ux;var uy2=-uy*-uy;var uxuy2=2*ux*-uy;var u2=ux2+uy2;var u215=1.5*u2;eq[0]=four9ths*rho*(1-u215);eq[1]=one9th*rho*(1+ux3+4.5*ux2-u215);eq[2]=one9th*rho*(1+uy3+4.5*uy2-u215);eq[3]=one9th*rho*(1-ux3+4.5*ux2-u215);eq[4]=one9th*rho*(1-uy3+4.5*uy2-u215);eq[5]=one36th*rho*(1+ux3+uy3+4.5*(u2+uxuy2)-u215);eq[6]=one36th*rho*(1-ux3+
uy3+4.5*(u2-uxuy2)-u215);eq[7]=one36th*rho*(1-ux3-uy3+4.5*(u2+uxuy2)-u215);eq[8]=one36th*rho*(1+ux3-uy3+4.5*(u2-uxuy2)-u215);return eq}function stream(){for(var x=0;x<lattice_width;x++)for(var y=0;y<lattice_height;y++){var node=lattice[x][y];if(!node.barrier)for(var d=0;d<9;d++){var move=node_directions[d];var newx=move.x+x;var newy=move.y+y;if(newx>=0&&(newx<lattice_width&&(newy>=0&&newy<lattice_height)))if(lattice[newx][newy].barrier)lattice[x][y].stream[reflection[d]]=node.distribution[d];else lattice[newx][newy].stream[d]=
node.distribution[d]}}}function collide(){var omega=module.omega;for(var x=1;x<lattice_width-1;x++)for(var y=1;y<lattice_height-1;y++){var node=lattice[x][y];if(!node.barrier){var d=node.distribution;for(var p=0;p<9;p++)d[p]=node.stream[p];var rho=d[0]+d[1]+d[2]+d[3]+d[4]+d[5]+d[6]+d[7]+d[8];var ux=(d[1]+d[5]+d[8]-d[3]-d[6]-d[7])/rho;var uy=(d[4]+d[7]+d[8]-d[2]-d[5]-d[6])/rho;node.density=rho;node.ux=ux;node.uy=uy;if(module.draw_mode==4&&(x>0&&(x<lattice_width-1&&(y>0&&y<lattice_height-1))))node.curl=
lattice[x+1][y].uy-lattice[x-1][y].uy-lattice[x][y+1].ux+lattice[x][y-1].ux;var ux3=3*ux;var uy3=3*uy;var ux2=ux*ux;var uy2=uy*uy;var uxuy2=2*ux*uy;var u2=ux2+uy2;var u215=1.5*u2;d[0]=d[0]+omega*(four9ths*rho*(1-u215)-d[0]);d[1]=d[1]+omega*(one9th*rho*(1+ux3+4.5*ux2-u215)-d[1]);d[2]=d[2]+omega*(one9th*rho*(1-uy3+4.5*uy2-u215)-d[2]);d[3]=d[3]+omega*(one9th*rho*(1-ux3+4.5*ux2-u215)-d[3]);d[4]=d[4]+omega*(one9th*rho*(1+uy3+4.5*uy2-u215)-d[4]);d[5]=d[5]+omega*(one36th*rho*(1+ux3-uy3+4.5*(u2-uxuy2)-u215)-
d[5]);d[6]=d[6]+omega*(one36th*rho*(1-ux3-uy3+4.5*(u2+uxuy2)-u215)-d[6]);d[7]=d[7]+omega*(one36th*rho*(1-ux3+uy3+4.5*(u2-uxuy2)-u215)-d[7]);d[8]=d[8]+omega*(one36th*rho*(1+ux3+uy3+4.5*(u2+uxuy2)-u215)-d[8])}}}function set_boundaries(){var u0=module.flow_speed;for(var x=0;x<lattice_width-1;x++){lattice[x][0].distribution=equilibrium(u0,0,1);lattice[x][lattice_height-1].distribution=equilibrium(u0,0,1)}for(var y=0;y<lattice_height-1;y++){lattice[0][y].distribution=equilibrium(u0,0,1);lattice[lattice_width-
1][y].distribution=equilibrium(u0,0,1)}}main.updater=function(){var steps=module.steps_per_frame;var q;set_boundaries();for(var i=0;i<steps;i++){stream();collide();if(particles.length>0)move_particles();while(queue.length>0){q=queue.shift();var node=lattice[q[0]][q[1]];var ux=q[2];var uy=q[3];node.distribution=equilibrium(ux,uy,node.density)}}module.drawing.draw();module.animation_id=requestAnimationFrame(main.updater)};main.init=function(){make_lattice(lattice_width,lattice_height);init_barrier([]);
init_flow(0,0,1);queue.length=0;module.drawing.draw()};main.init_barrier=init_barrier;main.init_flow_particles=init_flow_particles;return main}();return module}(boltzmann);boltzmann.main.init();
